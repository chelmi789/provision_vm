---
# tasks file for provision_vm
# tasks/main.yml
#- name: Create VM {{ vm_name }}
 # community.general.proxmox_kvm:
  #  api_user: "root@pam"
   # api_password: "ixelles1050"
    #api_host: "pve-pxs-sm2u-r5-33"
    #node: "{{ node }}"
    #vmid: "{{ vm_id }}"
    #name: "{{ vm_name }}"
    #memory: "{{ memory }}"
    #cores: "{{ cores }}"
    #scsihw: "virtio-scsi-pci"
    #boot: "cdn"
    #ide:
     # ide0: "{{ iso }},media=cdrom" 
    #ostype: "l26"
    #net:
     # net0: "model=virtio,bridge={{ network.bridge }},tag={{ network.vlan }}"
   # state: present
  #delegate_to: localhost

#- name: Generate SCSI mapping
 # set_fact:
  #  scsi_map: >-
   #   {{
    #    dict(
     #     ('scsi' ~ index|string, disk.storage ~ ':' ~ disk.size)
      #    for index, disk in disks | enumerate
     #   )
     # }}

#- name: Add disks to VM
 # community.general.proxmox_kvm:
  #  api_user: "root@pam"
   # api_password: "ixelles1050"
    #api_host: "pve-pxs-sm2u-r5-33"
    #node: "{{ node }}"
    #vmid: "{{ vm_id }}"
    #scsi: "{{ scsi_map }}"
    #state: present
  #delegate_to: localhost

#- name: Start VM {{ vm_name }}
 # community.general.proxmox_kvm:
  #  api_user: "root@pam"
   # api_password: "ixelles1050"
    #api_host: "pve-pxs-sm2u-r5-33"
   # node: "{{ node }}"
    #vmid: "{{ vm_id }}"
    #state: started
 # delegate_to: localhost


- name: Create VM
  community.general.proxmox_kvm:
    api_user: "{{ proxmox_api_user }}"
    api_password: "{{ proxmox_api_password }}"
    api_host: "{{ proxmox_api_host }}"
    node: "{{ proxmox_node }}"
    vmid: "{{ vm_id }}"
    name: "{{ vm_name }}"
    ostype: l26
    cores: "{{ cpu_cores }}"
    net:
      net0: 'virtio,bridge={{ network_bridge }},tag={{ vlan }}'
    memory: "{{ memory }}"
    state: present

- name: Create root disk
  community.general.proxmox_disk:
    api_user: "{{ proxmox_api_user }}"
    api_password: "{{ proxmox_api_password }}"
    api_host: "{{ proxmox_api_host }}"
    vmid: "{{ vm_id }}"
    disk: "virtio0"
    size: "local-lvm:50"
    format: raw
    state: present

- name: Create home disk
  community.general.proxmox_disk:
    api_user: "{{ proxmox_api_user }}"
    api_password: "{{ proxmox_api_password }}"
    api_host: "{{ proxmox_api_host }}"
    vmid: "{{ vm_id }}"
    disk: "virtio1"
    size: "local-lvm:30"
    format: raw
    state: present

- name: Create opt disk
  community.general.proxmox_disk:
    api_user: "{{ proxmox_api_user }}"
    api_password: "{{ proxmox_api_password }}"
    api_host: "{{ proxmox_api_host }}"
    vmid: "{{ vm_id }}"
    disk: "virtio2"
    size: "local-lvm:20"
    format: raw
    state: present

- name: Set boot order
  community.general.proxmox_kvm:
    api_user: "{{ proxmox_api_user }}"
    api_password: "{{ proxmox_api_password }}"
    api_host: "{{ proxmox_api_host }}"
    vmid: "{{ vm_id }}"
    boot: order=virtio0;virtio1;virtio2

- name: Start VM
  community.general.proxmox_kvm:
    api_user: "{{ proxmox_api_user }}"
    api_password: "{{ proxmox_api_password }}"
    api_host: "{{ proxmox_api_host }}"
    vmid: "{{ vm_id }}"
    state: started

